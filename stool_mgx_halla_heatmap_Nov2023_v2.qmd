---
title: "halla_heatmap"
format: html
editor: visual
---

## Quarto

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

## Running Code

When you click the **Render** button a document will be generated that includes both content and the output of embedded code. You can embed code like this:

```{r}
#| message: false

library(tidyverse)
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(patchwork)
```

You can add options to executable code like this

```{r}

create_halla_data <- function(folder){
  f_path <- "./HALLA/Stool_2clusters/"
  hallagram <- 
    paste0(f_path,folder,"/all_associations.txt") |> read_tsv() |> 
    rename(qval = `q-values`)
  stool_order <- 
    paste0(f_path,"stool_mtb.csv") |> read_csv() |> pull(mtb)
  stool_order <- factor(stool_order, levels = stool_order)

  halla_pos <- hallagram |> 
    filter(qval < 0.05) |> filter(association > 0)
  mtb_pos <- halla_pos |> select(X_features) |> unique()
  mgx_pos <- halla_pos |> select(Y_features) |> unique()

  halla2 <- hallagram |> 
    filter(X_features %in% mtb_pos$X_features) |> 
    filter(Y_features %in% mgx_pos$Y_features) |> 
    rename(Stool_metabolites = X_features, MGX = Y_features)

  stool_order <- intersect(stool_order, mtb_pos |> pull(X_features))

  halla2$Stool_metabolites <- factor(halla2$Stool_metabolites, 
                                     levels = stool_order)
  if(str_detect(folder,"ecs")){
    ecs_order <- paste0(f_path,folder,"/ecs.csv") |> 
      read_csv() |> pull(ecs)
    ecs_order <- factor(ecs_order, levels = ecs_order)
    ecs_order <- intersect(ecs_order, mgx_pos |> pull(Y_features))
    halla2 <- halla2 |> filter(MGX %in% ecs_order)
    halla2$MGX <- factor(halla2$MGX, levels = ecs_order)
    }

  if(str_detect(folder,"species")){
    for(i in 1:nrow(halla2)) {
      t11 <- str_split(halla2$MGX[i],'[|]') |> unlist()
      l <- length(t11)
      halla2$MGX[i] <- paste(t11[(l-2):l],collapse = "_")
      }
    }

  source("./Functions/heatmap_colormap.R")

  pl <- 
    halla2 |> ggplot() + 
    geom_tile(aes(x= Stool_metabolites, y = MGX, 
                fill = association), show.legend = T) +
    geom_point(aes(x= Stool_metabolites, y = MGX, alpha = qval<0.05), 
             shape = "*", size = 2.5, show.legend = FALSE) + 
    scale_alpha_manual(values = c(0,1), guide="none") + 
    scale_fill_gradientn(colours = col2, limits = c(-1,1)) +
    theme_minimal() + 
    theme(
      axis.text.x = element_text(angle = 36, hjust = 1, size = 7.25), 
      axis.text.y = element_text(size = 6.75),
      legend.text = element_text(size = 8)) +
    labs(x="Fecal metabolites", fill="Spearman r")
  return(pl)
  }
```

The `echo: false` option disables the printing of code (only output is displayed).

```{r}
#| message: false

sp_plot <- 
  create_halla_data("halla_res_Stool_2clusters_vs_MGXspecies_fdr005") +
  ylab("Fecal MGX species") + 
  theme(axis.title.x = element_blank())

ecs_plot <- 
  create_halla_data("halla_res_Stool_2clusters_vs_MGXecs_fdr005") + 
  ylab("Fecal MGX ecs") + 
  theme(axis.title.x = element_blank())

paths_plot <- 
  create_halla_data("halla_res_Stool_2clusters_vs_MGXpaths_fdr005") +
  ylab("Fecal MGX paths")
```

```{r}
#| message: false

layout <- "
AAAAAA
BBBBB#
CCCCCC
"

(sp_plot / paths_plot / ecs_plot) +
  plot_layout(guides = "collect",
              design = layout)

# ggsave(filename = "./R_figures/Hallagram_StoolVsMGX_t1.png", width = 9.65, height = 18.95, scale = 0.72)
```

```{r}
#| message: false

kegg_plot <- 
  create_halla_data("halla_res_Stool_2clusters_vs_MGX_kegg_fdr005") +
  ylab("Fecal MGX KEGG Ontology") + 
  theme(axis.title.x = element_blank(),
        axis.text = element_text(size = 14))

kegg_plot + 
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8))
```

```{r}

# for MGX_KEGG
# ggsave(filename = "~/Dropbox/Metabolomics/R_scripts/R_figures/Hallagram_StoolVsMGXkegg_zoomin2.png", width = 8.5, height = 8.5, scale = 0.65)
```
